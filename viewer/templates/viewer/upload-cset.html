{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Compound set upload</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.0.7/js/all.js"></script>
</head>
{% block content %}
{#    <h1>Compound set upload</h1>#}
{#    <h2>Instructions</h2>#}
{#    <p>Here, you can upload compound sets for follow up compounds (computed 3D coordinates)</p>#}
{#    <p>The current instructions are here: </p><a href="https://discuss.postera.ai/t/providing-computed-poses-for-others-to-look-at/1155">postera forum</a>#}
{#    <p>The current specification version is <b>ver_1.2</b></p>#}
{#    <br>#}
{#  <form method="post" enctype="multipart/form-data">#}
{#    {% csrf_token %}#}
{#    {{ form.as_ul }}#}
{#    <button type="submit">Submit</button>#}
{#  </form>#}
{#   {% autoescape off %}#}
{#       {{ download_url }}#}
{#       {{ table }}#}
{#   {% endautoescape %}#}
{##}
{#    <div class='progress-wrapper'>#}
{#      <div id='progress-bar' class='progress-bar' style="background-color: #68a9ef; width: 0%;">&nbsp;</div>#}
{#    </div>#}
{#    <div id="progress-bar-message">#}
{#        Waiting for progress to start...#}
{#    </div>#}
{##}
{#    <script src="{% static 'celery_progress/celery_progress.js' %}"></script>#}
{#    <script>#}
{#        // vanilla JS version#}
{#        document.addEventListener("DOMContentLoaded", function () {#}
{#            // on page load#}
{#            var progressUrl = "{% url 'celery_progress:task_status' 'task-id-stub' %}";#}
{#            // in callback function - assumes api response returns the task id#}
{#            var taskUrl = progressUrl.replace('task-id-stub', response.text);#}
{#            CeleryProgressBar.initProgressBar(progressUrl);#}
{#        });#}
{#    </script>#}
{##}
{#    <div id="celery-result"></div>#}

{#{% endblock %}#}




  <section class="hero is-primary is-fullheight-with-navbar">
    <div class="hero-body">
      <div class="container">
        <h1 class="title is-size-1 has-text-centered">Compound Set Upload</h1>
        <p class="subtitle has-text-centered" id="progress-title"></p>
        <div class="columns is-centered">
          <div class="column is-8">
              <p>Here, you can upload compound sets for follow up compounds (computed 3D coordinates)</p>
              <p>The current instructions are here: <a href="https://discuss.postera.ai/t/providing-computed-poses-for-others-to-look-at/1155">postera forum</a></p>
              <p>The current specification version is <b>ver_1.2</b></p>
              <br>
              <form method="post" enctype="multipart/form-data">
                  {% csrf_token %}
                  {{ form.as_ul }}
                <button type="submit">Submit</button>
            </form>
              {% autoescape off %}
                  {% if download_url %}
                    {{ download_url }}
                  {% endif %}
                  {% if table %}
                    {{ table }}
                  {% endif %}
              {% endautoescape %}
          </div>
        </div>
      </div>
    </div>
  </section>

    <script>
      var file = document.getElementById('{{form.sdf_file.id_for_label}}');
      file.onchange = function() {
        if(file.files.length > 0) {
          document.getElementById('file-name').innerHTML = file.files[0].name;
        }
      };
     </script>

      {% if task_id %}
          <script>
          var taskUrl = "{% url 'task' task_id=task_id %}";
          var dots = 1;
          var progressTitle = document.getElementById('progress-title');
          updateProgressTitle();
          var timer = setInterval(function() {
            updateProgressTitle();
            axios.get(taskUrl)
              .then(function(response){
                var taskStatus = response.data.task_status
                if (taskStatus === 'SUCCESS') {
                  clearTimer('Check downloads for results');
                  {#var url = window.location.protocol + '//' + window.location.host + response.data.results.archive_path;#}
                  {#var a = document.createElement("a");#}
                  {#a.target = '_BLANK';#}
                  {#document.body.appendChild(a);#}
                  {#a.style = "display: none";#}
                  {#a.href = url;#}
                  {#a.download = 'results.zip';#}
                  {#a.click();#}
                  {#document.body.removeChild(a);#}
                } else if (taskStatus === 'FAILURE') {
                  clearTimer('An error occurred');
                }
              })
              .catch(function(err){
                console.log('err', err);
                clearTimer('An error occurred');
              });
          }, 800);

          function updateProgressTitle() {
            dots++;
            if (dots > 3) {
              dots = 1;
            }
            progressTitle.innerHTML = 'processing uploaded files';
            for (var i = 0; i < dots; i++) {
              progressTitle.innerHTML += '.';
            }
          }
          function clearTimer(message) {
            clearInterval(timer);
            progressTitle.innerHTML = message;
          }
         </script>
  {% endif %}

{% endblock %}